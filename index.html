<!DOCTYPE html>
<html lang="ur">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Firebase Example</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore.js";

        let branches = {};  // Start with an empty object for branches

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDQFI1-btaatgf22CIjjwNFE23Kg-528pc",
            authDomain: "datacollection-7fe93.firebaseapp.com",
            projectId: "datacollection-7fe93",
            storageBucket: "datacollection-7fe93.appspot.com",
            messagingSenderId: "891438830971",
            appId: "1:891438830971:web:8fa97d2921757d6d83d9de",
            measurementId: "G-WG427C9P47"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        function renderMainPage() {
            const appElement = document.getElementById('app'); // Ensure this is the right element
            appElement.innerHTML = `
                <div class="container">
                    <h1>شاخ کی تفصیلات</h1>
                    <input type="text" id="branchCode" placeholder="شاخ کوڈ" oninput="fetchBranchDetails()">
                    <div id="branchDetails"></div>
                    <div id="submissionFields" style="display:none;">
                        <input type="text" id="yusi" placeholder="یوسی">
                        <input type="text" id="ward" placeholder="وارڈ نمبر">
                        <button onclick="submitData()">سبمٹ کریں</button>
                    </div>
                </div>
            `;
        }

        // Fetch branch details based on the code
        window.fetchBranchDetails = function() { // Declare as a global function
            const code = document.getElementById('branchCode').value;
            const detailsDiv = document.getElementById('branchDetails');
            const submissionDiv = document.getElementById('submissionFields');

            const branch = branches[code];

            if (branch) {
                detailsDiv.innerHTML = `
                    <h2>تفصیلات</h2>
                    <p>شاخ کوڈ: ${branch["شاخ کوڈ"]}</p>
                    <p>شاخ: ${branch["شاخ"]}</p>
                    <p>مجلس: ${branch["مجلس"]}</p>
                    <p>ضلع: ${branch["ڈسٹرکٹ"]}</p>
                    <p>ڈویژن: ${branch["سرکاری ڈویژن"]}</p>
                `;
                submissionDiv.style.display = 'block'; // Show submission input
            } else {
                detailsDiv.innerHTML = '<p>کوئی شاخ نہیں ملی۔ براہ کرم درست شاخ کوڈ درج کریں۔</p>';
                submissionDiv.style.display = 'none'; // Hide submission input
            }
        }

        // Submit data to Firebase
        window.submitData = async function() { // Declare as a global function
            const yusi = document.getElementById('yusi').value;
            const ward = document.getElementById('ward').value;
            const code = document.getElementById('branchCode').value;

            if (yusi && ward) {
                try {
                    await addDoc(collection(db, "submissions"), {
                        branchCode: code,
                        yusi: yusi,
                        ward: ward,
                        timestamp: serverTimestamp()
                    });
                    alert(`ڈیٹا محفوظ کر دیا گیا!\nشاخ کوڈ: ${code}\nیوسی: ${yusi}\nوارڈ: ${ward}`);
                } catch (error) {
                    console.error('Error saving data:', error);
                    alert("ڈیٹا محفوظ کرنے میں مسئلہ!");
                }
            } else {
                alert("یوسی اور وارڈ نمبر دونوں درج کریں!");
            }
        }

        // Load branch data from branchData.json
        async function loadBranchData() {
            try {
                const response = await fetch('branchData.json'); // Ensure this path is correct
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                
                branches = data.reduce((acc, branch) => {
                    acc[branch["شاخ کوڈ"]] = branch;
                    return acc;
                }, {});
            } catch (error) {
                console.error('Error loading branch data:', error);
            }
        }

        // Start the app once the DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            await loadBranchData();
            renderMainPage();
        });
    </script>
</head>
<body>
    <div id="app"></div>
</body>
</html>
